name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      # 1) æ©Ÿå¯†ã¯Actionså†…ã§ç”Ÿæˆ
      - name: Create config.js ğŸ—ï¸
        working-directory: ./frontend
        run: |
          echo "const firebaseConfig = {" > config.js
          echo "  apiKey: '${{ secrets.VITE_FIREBASE_API_KEY }}'," >> config.js
          echo "  authDomain: '${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}'," >> config.js
          echo "  projectId: '${{ secrets.VITE_FIREBASE_PROJECT_ID }}'," >> config.js
          echo "  storageBucket: '${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}'," >> config.js
          echo "  messagingSenderId: '${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}'," >> config.js
          echo "  appId: '${{ secrets.VITE_FIREBASE_APP_ID }}'," >> config.js
          echo "};" >> config.js
          echo "const cloudFunctionUrl = '${{ secrets.VITE_CLOUDFUNCTION_URL }}';" >> config.js
          ls -la config.js

      # 2) ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼ˆindex.htmlã®scriptå‚ç…§ã«ã‚³ãƒŸãƒƒãƒˆSHAã‚’ä»˜ä¸ï¼‰
      - name: Cache-bust script tag
        working-directory: ./frontend
        run: |
          SHORT=${GITHUB_SHA::7}
          # script.js ã®å‚ç…§ã« ?v=xxxx ã‚’ä»˜ã‘ã‚‹ï¼ˆå­˜åœ¨ã™ã‚Œã°ç½®æ›ã€ç„¡ã‘ã‚Œã°ç„¡è¦–ï¼‰
          sed -i "s|script\.js|script.js?v=$SHORT|g" index.html || true

      # 3) ãƒ‡ãƒ—ãƒ­ã‚¤ç›´å‰ã«ä¸­èº«ã‚’**å®Ÿä½“**ã§ç¢ºèªï¼ˆã“ã“ãŒæœ€æ–°ã‹ã©ã†ã‹ãŒçœŸå› ï¼‰
      - name: Show files to deploy ğŸ”
        run: |
          echo "Commit: $GITHUB_SHA"
          ls -la frontend
          echo "---- script.js (HEAD 20 lines) ----"
          sed -n '1,20p' frontend/script.js || true

      # 4) ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯æƒé™¤ï¼‰
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: frontend
          clean: true
          single-commit: true

      # 5) æœ¬å½“ã« gh-pages ã«åæ˜ ã•ã‚ŒãŸã‹ã‚’**ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰**ç¢ºèª
      - name: Verify on gh-pages branch âœ…
        uses: actions/checkout@v4
        with:
          ref: gh-pages
      - name: Show deployed script.js ğŸ”
        run: |
          echo "---- gh-pages/script.js (HEAD 20 lines) ----"
          sed -n '1,20p' script.js || true
